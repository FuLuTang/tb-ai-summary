# Thunderbird AI Summary Extension

[English](README.md) | [中文](README.zh-CN.md) | [开发指南](MODIFICATION_GUIDE.md)

## 这是什么？

这是一个允许你使用 AI 总结邮件的 Thunderbird 扩展。
它可以总结**单封邮件**，添加**标签**、**紧急度评分**，**一键自动批量生成总结**，并根据本地缓存的邮件摘要生成**智能简报**。

## 🚀 如何在 Thunderbird 中临时安装 (调试模式)

如果你想测试或开发此扩展，可以通过 Thunderbird 的调试功能临时加载它。

1.  **打开 Thunderbird**。
2.  点击右上角的菜单按钮 (≡)，选择 **“附加组件和主题” (Add-ons and Themes)**。
3.  在附加组件管理器页面的右上角，点击 **齿轮图标 (⚙️)**。
4.  选择 **“调试附加组件” (Debug Add-ons)**。
5.  在打开的调试页面中，点击 **“临时载入附加组件...” (Load Temporary Add-on...)** 按钮。
6.  在文件选择对话框中，导航到本项目的目录，并选择 **`manifest.json`** 文件。
7.  点击“打开”。

现在，你应该能在 Thunderbird 的工具栏上看到扩展的图标了。

> **注意**: 临时加载的扩展在关闭 Thunderbird 后会被移除。下次启动时需要重复上述步骤。

---

## 🛠 运行逻辑详解

此扩展主要由两部分组成：**Popup (前端界面)** 和 **Background (后台服务)**。它们通过消息机制进行通信。

### 1. 核心架构

*   **Popup (`popup.html` / `popup.js`)**:
    *   **职责**: 负责与用户交互，显示按钮、进度条和最终的总结结果。
    *   **交互**: 当用户点击按钮（如“开始总结”、“一键总结邮件”）时，它会向后台发送消息（`sendMessage`）。
    *   **监听**: 它会监听来自后台的实时消息（如进度更新、错误提示），并动态更新 UI。

*   **Background (`background.js`)**:
    *   **职责**: 处理核心逻辑，包括调用 Thunderbird API 读取邮件、调用 OpenAI API 生成总结、以及管理缓存。
    *   **持久化**: 使用 `browser.storage.local` 存储 API 设置和邮件总结缓存，避免重复消耗 Token。

### 2. 功能逻辑拆解

#### A. 单封邮件总结
1.  **触发**: 用户在阅读邮件时点击扩展图标，Popup 初始化并获取当前显示的邮件 ID。
2.  **请求**: 用户点击“开始总结”，Popup 发送 `START_SUMMARY` 消息。
3.  **处理**:
    *   后台检查是否存在缓存。如果有且未强制刷新，直接返回缓存结果。
    *   如果没有缓存，后台调用 `browser.messages.getFull` 获取邮件全文。
    *   解析邮件正文（去除 HTML 标签）。
    *   构建 Prompt（包含发件人、主题、正文），调用 OpenAI API。
4.  **响应**: AI 返回 JSON 格式的总结（包含摘要、标签、紧迫度评分）。后台将结果存入缓存，并广播 `SUMMARY_UPDATE` 消息给 Popup 进行渲染。

#### B. 一键批量总结 (Batch Summary)
1.  **触发**: 用户在 Popup 中输入数量（如 40）并点击“一键总结邮件”。
2.  **获取邮件**:
    *   后台遍历所有账户的收件箱 (`inbox`)。
    *   查询最近 N 天的邮件，直到收集到目标数量（如 40 封）。
3.  **并发队列**:
    *   为了防止触发 API 速率限制，后台使用令牌桶算法 (`createRateLimitedRunner`) 控制并发请求（默认每秒 5 个请求）。
    *   对每封邮件独立执行“单封邮件总结”的逻辑。
4.  **反馈**: 每完成一封，后台发送 `BATCH_PROGRESS` 消息，Popup 更新进度提示。

#### C. 智能简报 (Briefing)
1.  **触发**: 用户点击“新简报”。
2.  **筛选**: 后台从本地缓存中读取过去 30 天的所有总结记录。
3.  **过滤**: 筛选出 **紧迫度 (Urgency Score) > 6** 的高优先级邮件。
4.  **生成**:
    *   将这些高优先级邮件的摘要拼接成一个新的 Prompt。
    *   要求 AI 扮演“行政助理”，生成一份简明扼要的日报/周报。
5.  **展示**: 生成结果保存到本地，用户点击“查看已有简报”时，打开一个新的 Tab (`briefing.html`) 展示 Markdown 渲染后的简报。
